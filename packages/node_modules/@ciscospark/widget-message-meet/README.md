# Spark Message and Meet Widget _(@ciscospark/widget-message-meet)_

* THIS WIDGET CONTAINS EXPERIMENTAL CODE *

> The Spark Message Meet widget allows developers to easily incorporate Cisco Spark 1 on 1 messaging and meet into an application.


## Table of Contents
-   [Background](#background)
-   [Install](#install)
    -   [CDN](#cdn)
    -   [Build from Source](#build-from-source)
-   [Usage](#usage)
    -   [Quick Start](#quick-start)
    -   [HTML](#html)
      -   [Data API](#data-api)
      -   [Browser Globals](#browser-globals)
    -   [JSX](#jsx)
    -   [Events](#events)
    -   [Styles](#styles)
-   [Browser Support](#browser-support)


## Background

This widget handles the heavy lifting of coordinating between your application and the Spark APIs, and provides components of the Spark message and meet experience without having to build all front end UI yourself.

Our widget is built using React <https://github.com/facebook/react>, Redux <https://github.com/reactjs/redux>, and the Spark Javascript SDK <https://github.com/ciscospark/spark-js-sdk>.

This widget supports:
-   1 on 1 messaging
-   1 on 1 video calling
-   Inline Markdown
-   Sharing of files and documents
-   Preview and download of files and documents
-   Flagging messages for follow up


## Install

Depending on how comfortable you are with these frameworks, there are are a number of ways you can "install" our code.

### Spark for Developers

If you haven't already, go to the Spark for Developers Portal (<https://developers.ciscospark.com>) and sign up for an account. Once you've created an account you can get your developer access token by clicking on your avatar at the top right of the screen.

When you want to eventually create an integration and have your own users take advantage of the widget, you'll need to create an integration with the following scopes:

  ```
  spark:kms
  spark:rooms_read
  spark:rooms_write
  spark:memberships_read
  spark:memberships_write
  spark:messages_read
  spark:messages_write
  ```

Head over to the Spark for Developers Documentation for more information about how to setup OAuth for your app: <https://developer.ciscospark.com/authentication.html>

### CDN

Using our CDN requires the least amount of work to get started. Add the following into your HTML file:
```
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://code.s4d.io/widget-message-meet/production/main.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://code.s4d.io/widget-message-meet/production/bundle.js"></script>
```

### Build from Source

1.  Follow these instructions to checkout and build the `react-ciscospark` repo <https://github.com/ciscospark/react-ciscospark/blob/master/README.md>

1.  To build the Message and Meet Widget, run the following from the root directory:

  ```sh
  npm run build:package widget-message-meet
  ```


## Usage

### Quick Start

If you would just like to get running immediately, follow these instructions to get a webpack-dev-server running with the widget.

1.  Create a `.env` file in the root of the React project with the following lines, replacing the Xs with the appropriate value:

    ```
    CISCOSPARK_ACCESS_TOKEN=YOUR_ACCESS_TOKEN
    TO_PERSON_EMAIL=XXXXX@XXXXXXXXX
    ```
1.  From the root directory run: `npm start:package widget-message-meet`

### HTML

The easiest way to get the Spark Message and Meet Widget into your web site is to add the built resources and attach data attributes to your a container.

If you're using our CDN, skip to the next section.
  -  Copy the resources in the `dist` directory to own project.
  -  Add a `<script />` tag to your page to include the `bundle.js`
  -  Add a `<link />` tag to include `main.css`

#### Data API

If you would like to embed with the widget without any additional behaviors into your page, use this data api. The `div` containing our `data-toggle` attribute must exist on the page before our javascript bundle loads.

Create a container where you would like to embed the widget and add the following attributes to configure the widget:
  - `data-toggle="ciscospark-message-meet"`: (required)
  - `data-access-token`: (required) Access token for the user account initiating the messaging session. For testing purposes you can use a developer access token from <https://developers.ciscospark.com>.
  - `data-initial-activity`: (default: `message`) Activity view to open with the widget. Available options:
    - `message`: Message view
    - `meet`: Meet view
    - `activity-menu`: Open with the Activity menu visible
  - Include one of the following attributes:
    - `data-to-person-email`: Email of the message recipient.
    - `data-to-person-id`: User Id of the message recipient.
  - `data-start-call`: (default: `false`) When present, widget will start in Meet view and initiate a call with the toPerson immediately.

    ```html
    <div
      class="ciscospark-widget"
      data-toggle="ciscospark-message-meet"
      data-access-token="YOUR_ACCESS_TOKEN"
      data-to-person-email="XXXXX@XXXXXXXXX"
      data-initial-activity="message"
      data-start-call
      />
    ```

#### Browser Globals

If you need additional behaviors or need to do additional work before the widget loads, it may be useful for to programmatically instatiate the widget after the intial page loads.

```html
<div id="my-ciscospark-widget" />
<script>
  var widgetEl = document.getElementById('my-ciscospark-widget');
  // Init a new widget
  ciscospark.widget(widgetEl).messageMeetWidget({
    accessToken: 'YOUR_ACCESS_TOKEN',
    toPersonEmail: 'XXXXX@XXXXXXXXX',
    initialActivity: 'message'
  });
</script>
```

> `my-ciscospark-widget` is an arbitrary id to illustrate one way to select the DOM element.
> But please ensure that the `widgetEl` that you pass to `ciscospark.widget()` is a DOM element.

You can also attach to an existing widget. Currently this gives you access to [events](#events). Other functionality will be added in future releases.

``` js
var widgetEl = document.getElementById('ciscospark-widget-id');
var widgetObject = ciscospark.widget(widgetEl);
```

##### Widget Teardown

When a widget needs to be removed from the page you will want to call the `.remove()` method. This will close any network connections active and remove the widget from the DOM. You can also pass a callback as a parameter to the `.remove()` method. The method also returns a Promise that is thenable.

The returned value, `removed`, is `true` if a matching widget has been removed, and is `false` no widget was found.

``` js
// Basic remove
ciscospark.widget(widgetEl).remove();

// With callback
ciscospark.widget(widgetEl).remove(function(removed) {
  console.log('removed!');
});

// With Promise
ciscospark.widget(widgetEl).remove().then(function(removed) {
  console.log('removed!');
});
```


##### NOTE
> If you are also using the Spark JS SDK on the same page, please be sure to load that before you load the widget scripts.


### JSX

Because our widgets are built using React, you'll be able to directly import the modules and components into your React app.

Replace `YOUR_ACCESS_TOKEN` with the access token of the user who is going to be sending the messages (for development purposes this can just be your Developer Access Token), `TARGET_USER_EMAIL` with the email of the user who is receiving the messages, and `ELEMENT` with the ID of the element you want to inject into.

If you have the User ID of the recipient, you may provide that in the property `toPersonId` of `MessageMeetWidget` instead of using `toPersonEmail`.

``` js
import MessageMeetWidget from '@ciscospark/widget-message-meet';

ReactDOM.render(
  <MessageMeetWidget
    accessToken="YOUR_ACCESS_TOKEN"
    initialActivity="message"
    toPersonEmail="TARGET_USER_EMAIL"
    startCall
  />,
  document.getElementById('ELEMENT')
);
```

### Events

The Message Meet widget exposes a few events for hooking into widget functionality.
You can directly add DOM event listener like this:

``` html
<div
  id="ciscospark-widget"
  data-toggle="ciscospark-message-meet"
  data-access-token="YOUR_ACCESS_TOKEN"
  data-to-person-email="XXXXX@XXXXXXXXX"
  data-initial-activity="message"
  data-start-call
  />
<script>
  document.getElementById('ciscospark-widget').addEventListener('EVENT_NAME', function(event) {
    // Handle the event here
    console.log(event.detail);
  });
</script>
```

If you are using *browser globals*, you can provide a callback parameter that will fire whenever any event occurs. You can filter the actions using the name provided like this:

``` js
var widgetEl = document.getElementById('ciscospark-widget');
ciscospark.widget(widgetEl).messageMeetWidget({
  accessToken: 'YOUR_ACCESS_TOKEN',
  toPersonEmail: 'XXXXX@XXXXXXXXX',
  initialActivity: 'message',
  startCall: true,
  onEvent: callback
});

function callback(name, detail) {
  if (name === 'messages:created') {
    // Perform an action if a new message has been created
  }
}
```

Or you can use the (`ampersand-events`)[https://github.com/AmpersandJS/ampersand-events] API to listen to events like this:

``` js
var widgetEl = document.getElementById('ciscospark-widget');
ciscospark.widget(widgetEl).on('messages:created', function(e) {
  console.log(e.detail);
});
```

Currently available events:

* `messages:created` - A new message has been posted
* `messages:unread` - The conversation has unread messages
* `messages:read` - The conversation's messages have been read
* `calls:ringing` - An incoming call is ringing
* `calls:connected` - A call has been answered is now connected
* `calls:disconnected` - A active call has been disconnected

When handling one of the events listed above we will provide a `event.detail` object that looks something like this:

``` js
{
  resource: 'messages',
  event: 'created',
  actorId: 'Y2lzY29zcGFyazovL3VzL1BFT1BMRS8xZjdkZTVjYi04NTYxLTQ2NzEtYmMwMy1iYzk3NDMxNDQ0MmQ',
  data: {
    id: 'Y2lzY29zcGFyazovL3VzL01FU1NBR0UvMzIzZWUyZjAtOWFhZC0xMWU1LTg1YmYtMWRhZjhkNDJlZjlj',
    roomID: 'Y2lzY29zcGFyazovL3VzL1JPT00vUk9PTUlEMDAtUk9PTUlEMDAtUk9PTUlEMDAtUk9PTUlEMDA',
    object: {
      displayName: 'Message 123',
    },
    published: '2016-12-04T17:33:56.767Z'
  }
};
```

* `resource` - the resource the data is about.
* `event` - the type of event that was fired.
* `actorId` - the personId of the user that caused the event. For example, on a messsage created event, the author of the message will be the actorId.
* `data` - the resource that triggered the event. For example, when `messages` are `created`, the `data` will contain the payload of a message resource. When `calls` are `connected`, it will contain the details of a call resource.

### Styles

The widget grows and shrinks based on the size of the container that you place it in. If you do not provide a container, the widget will fill the space of the closest parent.

In order to constrain the size of the widget, you must place it inside of another container, like this:

``` html
<div style="height: 500px; width:100px;">
  <div class="ciscospark-widget" />
</div>
```

## Browser Support

This widget supports the follow browsers messaging:
-   Current release of Chrome
-   Current release of Firefox
-   Internet Explorer 11 or later

Calling will only work on:
-   Current release of Chrome
-   Current release of Firefox

## Contribute

Please see [CONTRIBUTING.md](../../../../CONTRIBUTING.md) for more details.

## License

&copy; 2016 Cisco and/or its affiliates. All Rights Reserved.
