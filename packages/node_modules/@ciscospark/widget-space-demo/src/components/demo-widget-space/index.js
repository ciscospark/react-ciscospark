/* eslint-disable react/no-set-state,react/forbid-component-props,react/jsx-no-literals */
/* global ciscospark */
import React, {Component} from 'react';
import classNames from 'classnames';
import {Cookies, withCookies} from 'react-cookie';
import {instanceOf} from 'prop-types';
import {autobind} from 'core-decorators';

import TextField from 'material-ui/TextField';
import {Tabs, Tab} from 'material-ui/Tabs';
import RaisedButton from 'material-ui/RaisedButton';
import AppBar from 'material-ui/AppBar';
import Toggle from 'material-ui/Toggle';
import {RadioButtonGroup, RadioButton} from 'material-ui/RadioButton';
import {Card, CardActions, CardTitle, CardText} from 'material-ui/Card';

import Highlight from 'react-highlight';
import 'highlight.js/styles/default.css';

import TokenInput from '../token-input';

import styles from './styles.css';

const MODE_ONE_ON_ONE = `MODE_ONE_ON_ONE`;
const MODE_SPACE = `MODE_SPACE`;

const widgetElementId = `my-ciscospark-widget`;

class DemoWidgetSpace extends Component {
  constructor(props) {
    super(props);
    const {cookies} = this.props;
    const hasToken = !!cookies.get(`accessToken`);
    const toPersonEmail = cookies.get(`toPersonEmail`) || ``;
    const spaceId = cookies.get(`spaceId`) || ``;
    let mode;
    if (spaceId) {
      mode = MODE_SPACE;
    }
    else if (toPersonEmail) {
      mode = MODE_ONE_ON_ONE;
    }
    this.state = {
      accessToken: cookies.get(`accessToken`) || ``,
      authenticate: false,
      displayToken: false,
      hasToken,
      mode,
      running: false,
      toPersonEmail,
      spaceId
    };
  }

  shouldComponentUpdate() {
    return true;
  }

  @autobind
  handleSubmit(e) {
    e.preventDefault();
    const {cookies} = this.props;
    cookies.set(`accessToken`, this.state.accessToken);
    if (this.state.mode === MODE_ONE_ON_ONE) {
      cookies.set(`toPersonEmail`, this.state.toPersonEmail);
    }
    else {
      cookies.set(`spaceId`, this.state.spaceId);
    }
    const toPerson = this.state.mode === MODE_ONE_ON_ONE ? this.state.toPersonEmail : ``;
    const toSpace = this.state.mode === MODE_SPACE ? this.state.spaceId : ``;
    const widgetEl = document.getElementById(widgetElementId);
    if (toPerson) {
      ciscospark.widget(widgetEl).spaceWidget({
        accessToken: this.state.accessToken,
        onEvent: (eventName, detail) => {
          // eslint-disable-next-line object-shorthand
          window.ciscoSparkEvents.push({eventName: eventName, detail: detail});
        },
        toPersonEmail: toPerson
      });
    }
    if (toSpace) {
      ciscospark.widget(widgetEl).spaceWidget({
        accessToken: this.state.accessToken,
        onEvent: (eventName, detail) => {
          // eslint-disable-next-line object-shorthand
          window.ciscoSparkEvents.push({eventName: eventName, detail: detail});
        },
        spaceId: toSpace
      });
    }
    this.setState({running: true});
  }

  @autobind
  handleAccessTokenChange(accessToken) {
    return this.setState({accessToken, hasToken: !!accessToken});
  }

  @autobind
  handleDisplayAccessTokenChange(e, displayToken) {
    return this.setState({displayToken});
  }

  @autobind
  handleEmailChange(e) {
    return this.setState({toPersonEmail: e.target.value});
  }

  @autobind
  handleModeChange(e, value) {
    return this.setState({mode: value});
  }

  @autobind
  handleSpaceChange(e) {
    return this.setState({spaceId: e.target.value});
  }

  // eslint-disable-next-line complexity
  generateExampleCode(state) {
    const {accessToken, displayToken, spaceId, toPersonEmail} = state;
    const displayedAccessToken = displayToken ? accessToken : `YOUR_ACCESS_TOKEN`;
    let globalToField, inlineToField;
    if (this.state.mode === MODE_ONE_ON_ONE) {
      inlineToField = `data-to-person-email="${toPersonEmail ? toPersonEmail : `TO_PERSON_EMAIL`}"`;
      globalToField = `toPersonEmail: '${toPersonEmail ? toPersonEmail : `TO_PERSON_EMAIL`}'`;
    }
    else {
      globalToField = `spaceId: '${spaceId ? spaceId : `SPACE_ID`}'`;
      inlineToField = `data-space-id="${spaceId ? spaceId : `SPACE_ID`}"`;
    }

    const inlineCode = `<div data-toggle="ciscospark-space" data-access-token="${displayedAccessToken}" ${inlineToField} />`;
    const globalCode = `<div id="my-ciscospark-widget" />
<script>
  var widgetEl = document.getElementById('my-ciscospark-widget');
  // Init a new widget
  ciscospark.widget(widgetEl).spaceWidget({
    accessToken: '${displayedAccessToken}',
    ${globalToField}
  });
</script>`;
    return {
      globalCode,
      inlineCode
    };
  }

  render() {
    const hasToPerson = this.state.mode === MODE_ONE_ON_ONE && this.state.toPersonEmail;
    const hasToSpace = this.state.mode === MODE_SPACE && this.state.spaceId;
    const loadButtonEnabled = this.state.accessToken && (hasToPerson || hasToSpace);
    const {globalCode, inlineCode} = this.generateExampleCode(this.state);
    const componentContainerClassNames = [
      styles.widgetComponentContainer
    ];
    if (!this.state.running) {
      componentContainerClassNames.push(styles.hidden);
    }

    return (
      <div>
        <AppBar title="Cisco Spark Space Widget" />
        <div className={classNames(`ciscospark-demo-wrapper`, styles.demoWrapper)}>
          <div className={classNames(componentContainerClassNames)}>
            <div id={widgetElementId} />
          </div>
          <Card initiallyExpanded style={{margin: `10px`}}>
            <CardTitle
              actAsExpander
              showExpandableButton
              subtitle="The Spark Space widget allows developers to easily incorporate Cisco Spark Space messaging into an application."
              title="Cisco Spark Space Widget Demo"
            />
            <CardText expandable>
              This widget handles coordination between your application and the Spark APIs, and provides components of the Spark space experience without having to build all of the front end UI yourself.
              <br />
              Our widget is built using <a href="https://github.com/facebook/react">React</a>, <a href="https://github.com/reactjs/redux">Redux</a>, and the <a href="https://github.com/ciscospark/spark-js-sdk">Spark Javascript SDK </a>.
            </CardText>
          </Card>
          <TokenInput onLogin={this.handleAccessTokenChange} token={this.state.accessToken} />
          <Card initiallyExpanded style={{margin: `10px`}}>
            <CardTitle
              actAsExpander
              showExpandableButton
              subtitle="Cisco Spark Space Widget can open to a space or person."
              title="Choose Widget Destination"
            />
            <CardText expandable>
              <div className={classNames(styles.select)}>
                <RadioButtonGroup
                  aria-label="Widget 'To' Type"
                  name="toType"
                  onChange={this.handleModeChange}
                  value={this.state.mode}
                >
                  <RadioButton
                    aria-label="To Space"
                    label="To Space"
                    value={MODE_SPACE}
                  />
                  <RadioButton
                    aria-label="To Person"
                    label="To Person"
                    value={MODE_ONE_ON_ONE}
                  />
                </RadioButtonGroup>
              </div>
              {this.state.mode === MODE_SPACE &&
              <div>
                <TextField
                  aria-label="To Space ID"
                  floatingLabelFixed
                  floatingLabelText="To Room/Space Id"
                  hintText="Spark Space Id"
                  id="toSpaceId"
                  onChange={this.handleSpaceChange}
                  value={this.state.spaceId}
                />
              </div>
              }
              {this.state.mode === MODE_ONE_ON_ONE &&
              <div>
                <TextField
                  aria-label="To User Email"
                  floatingLabelFixed
                  floatingLabelText="To User Email"
                  hintText="Spark User Email (For 1:1)"
                  id="toUserEmail"
                  onChange={this.handleEmailChange}
                  value={this.state.toPersonEmail}
                />
              </div>
              }
            </CardText>
            <CardActions expandable>
              <RaisedButton
                aria-label="Open Widget"
                disabled={!loadButtonEnabled}
                id="openWidgetButton"
                label={`Open Embedded Widget`}
                onClick={this.handleSubmit}
                primary
              />
            </CardActions>
          </Card>
          <Card initiallyExpanded style={{margin: `10px`}}>
            <CardTitle
              actAsExpander
              showExpandableButton
              subtitle="Cisco Spark Space Widget can be implemented multiple ways."
              title="Widget Example Code"
            />
            <CardText expandable>
              <div className={classNames(styles.example)}>
                <Tabs>
                  <Tab label={`Inline Mode`}>
                    <div className={classNames(`ciscospark-example-code`, styles.exampleCode)}>
                      <Highlight>
                        {inlineCode}
                      </Highlight>
                    </div>
                  </Tab>
                  <Tab label={`Global Mode`}>
                    <div className={classNames(`ciscospark-example-code`, styles.exampleCode)}>
                      <Highlight>
                        {globalCode}
                      </Highlight>
                    </div>
                  </Tab>
                </Tabs>
                <div className={classNames(`ciscospark-toggle`, styles.toggle)}>
                  <div>
                    <Toggle
                      label="Display Access Token"
                      labelPosition="right"
                      onToggle={this.handleDisplayAccessTokenChange}
                    />
                  </div>
                </div>
              </div>
            </CardText>
          </Card>
        </div>
      </div>
    );
  }
}

DemoWidgetSpace.propTypes = {
  cookies: instanceOf(Cookies).isRequired
};

DemoWidgetSpace.title = `Widget Space`;
DemoWidgetSpace.path = `/widget-space-demo`;

export default withCookies(DemoWidgetSpace);
